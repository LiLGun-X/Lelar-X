#!/bin/bash
# ==================================
# ModuX Updater
# Author: gunx
# ==================================

set -e

# ===== CONFIG =====
GITHUB_REPO="https://github.com/LiLGun-X/Lelar-X"
MODUX_DIR="/bin/modux"
TMP_DIR="/tmp/modux_update"

# ===== CHECK ROOT =====
if [ "$EUID" -ne 0 ]; then
  echo "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢ root (sudo)"
  exit 1
fi

# ===== FUN BAR =====
fun_bar () {
  (
    $1 > /dev/null 2>&1
    $2 > /dev/null 2>&1
    touch /tmp/fim
  ) &
  tput civis
  echo -ne "  \033[1;33m‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...\033[1;33m["
  while true; do
    for((i=0; i<18; i++)); do
      echo -ne "\033[1;32m‚ñà"
      sleep 0.1
    done
    [[ -f /tmp/fim ]] && rm /tmp/fim && break
  done
  echo -e "\033[1;33m]\033[1;32m OK\033[0m"
  tput cnorm
}

echo "üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ModuX..."

# ===== CHECK EXIST =====
if [ ! -d "$MODUX_DIR" ]; then
  echo "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö ModuX (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á)"
  exit 1
fi

# ===== CLEAN TMP =====
rm -rf "$TMP_DIR"
mkdir -p "$TMP_DIR"

# ===== CLONE REPO =====
echo "üì• ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å GitHub..."
fun_bar \
"git clone $GITHUB_REPO $TMP_DIR" \
"sleep 1"

# ===== CHECK MODUX =====
if [ ! -d "$TMP_DIR/modux" ]; then
  echo "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå modux ‡πÉ‡∏ô repo"
  exit 1
fi

# ===== SYNC FILES =====
echo "üìÇ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå..."
fun_bar \
"rsync -a --delete $TMP_DIR/modux/ $MODUX_DIR/" \
"sleep 1"

# ===== PERMISSION =====
echo "üîë ‡∏ï‡∏±‡πâ‡∏á permission..."
fun_bar \
"chmod -R 755 $MODUX_DIR" \
"sleep 1"

# ===== CLEAN =====
rm -rf "$TMP_DIR"

echo
echo "‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"
echo "üëâ ‡∏û‡∏¥‡∏°‡∏û‡πå menux ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠"
