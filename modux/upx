#!/bin/bash
# ==================================
# ModuX Updater
# Author: gunx
# ==================================

set -e

# ===== CONFIG =====
GITHUB_REPO="https://github.com/LiLGun-X/Lelar-X"
MODUX_DIR="/bin/modux"
TMP_DIR="/tmp/modux_update"
BIN_DIR="/bin"

# ===== CHECK ROOT =====
if [ "$EUID" -ne 0 ]; then
  echo "âŒ à¸à¸£à¸¸à¸“à¸²à¸£à¸±à¸™à¸”à¹‰à¸§à¸¢ root (sudo)"
  exit 1
fi

echo "ðŸ”„ à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸±à¸›à¹€à¸”à¸• ModuX..."

# ===== CLEAN TMP =====
rm -rf "$TMP_DIR"
mkdir -p "$TMP_DIR"

# ===== CLONE REPO =====
echo "ðŸ“¥ à¸”à¸¶à¸‡à¹„à¸Ÿà¸¥à¹Œà¸ˆà¸²à¸ GitHub..."
git clone "$GITHUB_REPO" "$TMP_DIR"

# ===== CHECK MODUX =====
if [ ! -d "$TMP_DIR/modux" ]; then
  echo "âŒ à¹„à¸¡à¹ˆà¸žà¸šà¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ modux à¹ƒà¸™ repo"
  exit 1
fi

# ===== UPDATE FILES =====
echo "ðŸ“‚ à¸­à¸±à¸›à¹€à¸”à¸•à¹„à¸Ÿà¸¥à¹Œà¹„à¸›à¸—à¸µà¹ˆ $MODUX_DIR"
rm -rf "$MODUX_DIR"
cp -r "$TMP_DIR/modux" "$MODUX_DIR"

# ===== PERMISSION =====
echo "ðŸ”‘ à¸•à¸±à¹‰à¸‡ permission à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´..."
find "$MODUX_DIR" -type d -exec chmod 755 {} \;
find "$MODUX_DIR" -type f -exec chmod 755 {} \;

# ===== CLEAN OLD COMMANDS =====
echo "ðŸ§¹ à¸¥à¹‰à¸²à¸‡ command à¹€à¸à¹ˆà¸²à¸—à¸µà¹ˆà¸Šà¸µà¹‰à¹„à¸› modux..."
for f in "$BIN_DIR"/*; do
  [[ -L "$f" && "$(readlink "$f")" == "$MODUX_DIR"* ]] && rm -f "$f"
done

# ===== AUTO REGISTER COMMANDS =====
echo "ðŸ”— à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´..."

for item in "$MODUX_DIR"/*; do
  name=$(basename "$item")

  # à¸‚à¹‰à¸²à¸¡à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸„à¸§à¸£à¹€à¸›à¹‡à¸™à¸„à¸³à¸ªà¸±à¹ˆà¸‡
  [[ "$name" =~ \.(md|txt|conf|json)$ ]] && continue

  # ===== FILE =====
  if [[ -f "$item" ]]; then
    chmod +x "$item"
    ln -sf "$item" "$BIN_DIR/$name"
    echo "âœ” command: $name"

  # ===== FOLDER (à¸•à¹‰à¸­à¸‡à¸¡à¸µ main) =====
  elif [[ -d "$item" && -f "$item/main" ]]; then
    chmod +x "$item/main"

    cat > "$BIN_DIR/$name" <<EOF
#!/bin/bash
exec "$item/main" "\$@"
EOF

    chmod +x "$BIN_DIR/$name"
    echo "âœ” menu: $name"
  fi
done

# ===== CLEAN =====
rm -rf "$TMP_DIR"

echo "âœ… à¸­à¸±à¸›à¹€à¸”à¸• ModuX à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!"
echo "ðŸ‘‰ à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¹ƒà¸«à¸¡à¹ˆà¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰à¸—à¸±à¸™à¸—à¸µ"
